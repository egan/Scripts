#!/bin/bash

##
# turl -- shorten a url using tinyurl.com
#
# usage -- turl URL, accepts stdin
#
# notes -- watch out for problematic characters
#
# written -- 4 July 2010 by Egan McComb
#
# revised -- 7 July 2010 by author
##

ERR_NARGS=3

COMMAND="curl"
COPTION=" -s -d"
PSTDATA='url="$URL"'
SERVICE="http://tinyurl.com/create.php"

usage()
{
	echo "Usage: $(basename $0) URL" >&2
	echo -e "\t-Alternatively, accepts stdin" >&2
	echo -e "\t-Watch out for ampersands" >&2
	echo -e "\t and other special characters" >&2
}

chkargs()
{
	if [ -z "$1" ] && [ -t 0 ] 
	then
		echo "Error: No input given" >&2
		usage
		exit $ERR_NARGS
	elif [ $# -gt 1 ] || [ ! -z "$1" ] && [ ! -t 0 ]
	then
		echo "Error: Excess input" >&2
		usage
		exit $ERR_NARGS
	elif [ ! -z "$1" ]
	then
		URL="$1"
	else
		read -r URL
	fi
}

##----MAIN----##
chkargs "$@"

OUT=$(eval $COMMAND $COPTION $PSTDATA $SERVICE | sed -n 's/.*\(http:\/\/tinyurl.com\/[a-z0-9][a-z0-9]*\).*/\1/p' | uniq)
echo -n $OUT | xclip
echo $OUT

exit 0
