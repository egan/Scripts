#!/bin/bash

##
# upaur -- check arch user repository for updates to foreign packages
#
# usage -- upaur
#
# written -- 2 October, 2010 by Egan McComb
#
# revised -- 7 November, 2010 by author
#            6 June, 2011 by author
##

AURL="http://aur.archlinux.org/packages"
AURQ="http://aur.archlinux.org/rpc.php?type=info&arg="
PACQ=$(pacman -Qm | tr " " ";")
DEST="$HOME/src/aur"
CURL="curl -s"
WGET="wget -qP $DEST"

extern()
{
	EXTRN=$($CURL ${AURQ}$PKGNM | jshon -e results -e Version -u)
}

output()
{
	printf "%-30s -- %s\n" $PKGNM $STATUS
	if [ $STATUS = "OUTDATED" ]
	then
		echo -ne "\E[01;34m::\033[0m Retrieve tarball? [Y/n] "
		read REPLY
		if [ $REPLY = "Y" ] || [ $REPLY = "y" ]
		then
			$WGET $AURL/$PKGNM/$PKGNM.tar.gz
		fi
	fi
}

##----MAIN----##
for PKG in $PACQ
do
	PKGNM=$(cut -d ";" -f 1 <<< $PKG)
	LOCAL=$(cut -d ";" -f 2 <<< $PKG)
	extern

	if $(grep -q "git" <<< "$PKGBF")
	then
		STATUS="UNKNOWN"
	else
		if [ $LOCAL = "$EXTRN" ]
		then
			STATUS="CURRENT"
		else
			STATUS="OUTDATED"
		fi
	fi
	output
done

exit 0
